# 智能预加载使用指南

## 🎯 设计理念

**问题：** About 页面图片很大，首屏加载会拖慢速度，但点击进入又很慢。

**解决方案：** 鼠标悬停时预加载 → 用户点击时图片已就绪 → 页面秒开！

## 📦 已创建的文件

### 1. Composable: `useImagePreload.ts`
提供图片预加载的核心功能

### 2. 组件: `PreloadLink.vue`
智能预加载链接组件，鼠标悬停时自动预加载

## 🚀 使用方法

### 方法一：使用 PreloadLink 组件（推荐）

#### 在导航栏中使用

```vue
<template>
  <nav>
    <!-- 普通链接 -->
    <NuxtLink to="/">首页</NuxtLink>
    
    <!-- 智能预加载链接 - 鼠标悬停时预加载 About 图片 -->
    <PreloadLink to="/about" preload-type="about">
      关于
    </PreloadLink>
    
    <!-- 自定义预加载图片 -->
    <PreloadLink 
      to="/gallery" 
      preload-type="custom"
      :custom-images="['/images/gallery/1.jpg', '/images/gallery/2.jpg']"
    >
      相册
    </PreloadLink>
  </nav>
</template>
```

#### 在任何地方使用

```vue
<template>
  <div class="card">
    <h3>了解更多</h3>
    <PreloadLink to="/about" preload-type="about" class="btn">
      查看关于页面
    </PreloadLink>
  </div>
</template>
```

### 方法二：手动调用 Composable

```vue
<script setup lang="ts">
import { useImagePreload } from '~/composables/useImagePreload'

const { preloadAboutImages, preloadBannerImages } = useImagePreload()

// 在需要的时候手动预加载
const handleMouseEnter = () => {
  preloadAboutImages()
}
</script>

<template>
  <NuxtLink to="/about" @mouseenter="handleMouseEnter">
    关于
  </NuxtLink>
</template>
```

### 方法三：页面级预加载

在 About 页面的 `onMounted` 中预加载：

```vue
<!-- pages/about.vue -->
<script setup lang="ts">
import { useImagePreload } from '~/composables/useImagePreload'

const { preloadAboutImages } = useImagePreload()

// 进入页面后立即预加载
onMounted(() => {
  preloadAboutImages()
})
</script>
```

## 🎨 完整示例

### 导航栏组件示例

```vue
<!-- components/common/navbar.vue -->
<template>
  <nav class="navbar">
    <div class="nav-links">
      <NuxtLink to="/" class="nav-item">
        首页
      </NuxtLink>
      
      <!-- 使用智能预加载 -->
      <PreloadLink to="/about" preload-type="about" class="nav-item">
        关于
      </PreloadLink>
      
      <PreloadLink to="/articles" preload-type="banner" class="nav-item">
        文章
      </PreloadLink>
      
      <NuxtLink to="/contact" class="nav-item">
        联系
      </NuxtLink>
    </div>
  </nav>
</template>

<style scoped>
.nav-item {
  padding: 10px 20px;
  transition: all 0.3s;
}

.nav-item:hover {
  background: rgba(255, 255, 255, 0.1);
}
</style>
```

## ⚡ 性能对比

### 方案对比

| 方案 | 首屏加载 | About 页面打开速度 | 用户体验 |
|------|---------|-------------------|---------|
| ❌ 不预加载 | 快 | 慢（需等待 2.85MB） | 差 |
| ❌ 首屏预加载 | 慢（+2.85MB） | 快 | 差 |
| ✅ 智能预加载 | 快 | 快（已预加载） | 优秀 |

### 时间线对比

#### 传统方式
```
用户访问首页 → 浏览内容 → 点击"关于" → 等待 2-3 秒 → 图片加载完成
                                      ↑ 用户感知延迟
```

#### 智能预加载
```
用户访问首页 → 浏览内容 → 鼠标悬停"关于"(0.5秒) → 点击"关于" → 立即显示
                              ↑ 后台预加载          ↑ 无感知延迟
```

## 🔧 API 文档

### PreloadLink 组件

#### Props

| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `to` | `string` | - | 目标路由（必填） |
| `preload-type` | `'about' \| 'banner' \| 'custom'` | - | 预加载类型 |
| `custom-images` | `string[]` | `[]` | 自定义图片列表 |

#### 事件

- `@mouseenter` - 鼠标进入时触发预加载
- `@touchstart` - 触摸开始时触发预加载（移动端）

### useImagePreload Composable

#### 方法

```typescript
const {
  // 预加载单张图片
  preloadImage,
  
  // 批量预加载图片
  preloadImages,
  
  // 预加载 About 页面图片
  preloadAboutImages,
  
  // 预加载 Banner 图片
  preloadBannerImages,
  
  // 检查图片是否已预加载
  isPreloaded
} = useImagePreload()
```

#### 使用示例

```typescript
// 预加载单张图片
await preloadImage('/images/about/1.jpg')

// 批量预加载
await preloadImages([
  '/images/about/1.jpg',
  '/images/about/2.jpg'
])

// 预加载 About 页面所有图片
await preloadAboutImages()

// 检查是否已预加载
if (isPreloaded('/images/about/1.jpg')) {
  console.log('图片已在缓存中')
}
```

## 📊 实际效果测试

### 测试步骤

1. **首屏加载测试**
   ```bash
   pnpm dev
   # 打开浏览器开发者工具 → Network
   # 访问首页，查看加载的资源
   # 应该只看到 banner/1.jpg 被预加载
   ```

2. **智能预加载测试**
   ```bash
   # 鼠标悬停在"关于"链接上（不点击）
   # 查看 Network 面板
   # 应该看到 about 文件夹的图片开始加载
   ```

3. **页面打开速度测试**
   ```bash
   # 悬停 0.5 秒后点击"关于"
   # 页面应该秒开，图片立即显示
   ```

## 🎯 最佳实践

### 1. 预加载时机

```vue
<!-- ✅ 推荐：鼠标悬停时预加载 -->
<PreloadLink to="/about" preload-type="about">关于</PreloadLink>

<!-- ⚠️ 可选：页面加载后延迟预加载 -->
<script setup>
onMounted(() => {
  setTimeout(() => {
    preloadAboutImages()
  }, 3000) // 3秒后预加载
})
</script>

<!-- ❌ 不推荐：首屏立即预加载 -->
<script setup>
onMounted(() => {
  preloadAboutImages() // 影响首屏性能
})
</script>
```

### 2. 预加载优先级

```typescript
// 高优先级：首屏可见图片
{ rel: 'preload', href: '/images/banner/1.jpg', as: 'image' }

// 中优先级：鼠标悬停时预加载
<PreloadLink to="/about" preload-type="about" />

// 低优先级：懒加载
<img src="/images/banner/2.jpg" loading="lazy" />
```

### 3. 移动端优化

```vue
<template>
  <!-- 移动端可以禁用预加载，节省流量 -->
  <PreloadLink 
    v-if="!isMobile"
    to="/about" 
    preload-type="about"
  >
    关于
  </PreloadLink>
  
  <NuxtLink v-else to="/about">
    关于
  </NuxtLink>
</template>

<script setup>
const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent)
</script>
```

## 🔍 调试技巧

### 查看预加载状态

```vue
<script setup>
const { isPreloaded } = useImagePreload()

// 检查图片是否已预加载
console.log('About 图片已预加载:', isPreloaded('/images/about/1.jpg'))
</script>
```

### 监控预加载性能

```typescript
const { preloadAboutImages } = useImagePreload()

const startTime = performance.now()
await preloadAboutImages()
const endTime = performance.now()

console.log(`预加载耗时: ${endTime - startTime}ms`)
```

## 📝 迁移清单

- [x] 创建 `useImagePreload.ts` composable
- [x] 创建 `PreloadLink.vue` 组件
- [x] 更新 `nuxt.config.ts` 移除全局预加载
- [ ] 执行 `migrate-images.ps1` 迁移图片
- [ ] 在导航栏中使用 `PreloadLink` 组件
- [ ] 更新所有图片引用路径
- [ ] 测试预加载效果
- [ ] 验证首屏性能

## 🎉 总结

**智能预加载方案的优势：**

✅ **首屏快** - 只加载必需的 banner/1.jpg（约 230KB）  
✅ **About 页面快** - 鼠标悬停时已预加载，点击秒开  
✅ **用户体验好** - 无感知延迟，流畅过渡  
✅ **灵活可控** - 可以针对不同页面定制预加载策略  
✅ **移动端友好** - 可以根据设备类型调整策略  

这是目前最优的解决方案！🚀
